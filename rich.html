<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‚¡å¸‚å¤§å¯Œç¿ - ç»ˆæä¿®å¤ç‰ˆ</title>
    <style>
        :root {
            --p1-color: #3498db;
            --p2-color: #e74c3c;
            --board-bg: #ecf0f1;
            --cell-bg: #fff;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            margin: 0;
            overflow: hidden;
            user-select: none;
        }

        #game-container {
            width: 98vw;
            max-width: 1100px;
            height: 96vh; 
            max-height: 850px;
            background-color: var(--board-bg);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: grid;
            grid-template-columns: 260px 1fr;
            padding: 15px;
            gap: 15px;
            box-sizing: border-box;
            position: relative;
        }

        /* --- å·¦ä¾§é¢æ¿ --- */
        #control-panel {
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 100%;
            box-sizing: border-box;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        /* æ¸¸æˆç›®æ ‡çŠ¶æ€æ  */
        .game-status {
            background: #2c3e50;
            color: #fff;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .progress-bar-bg {
            width: 100%; height: 6px; background: #555; border-radius: 3px; margin-top: 5px; overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%; background: #f1c40f; width: 0%; transition: width 0.5s;
        }

        .player-card {
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #f0f0f0;
            background: #fafafa;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        .player-card.active {
            border-color: #f1c40f;
            background-color: #fffde7;
            transform: scale(1.02);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .money-display { font-size: 20px; color: #27ae60; font-family: 'Consolas', monospace; font-weight: bold; }
        
        #log-box {
            flex-grow: 1;
            overflow-y: auto;
            font-size: 12px;
            border-top: 1px solid #eee;
            padding-top: 5px;
            color: #555;
            line-height: 1.5;
            min-height: 50px;
        }

        #action-area {
            margin-top: auto; 
            height: 150px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            perspective: 600px;
            flex-shrink: 0;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        /* --- 3Déª°å­ --- */
        .cube-wrapper { width: 50px; height: 50px; position: absolute; top: 10px; transform-style: preserve-3d; }
        .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 1.2s cubic-bezier(0.1, 0.6, 0.3, 1); }
        .cube-face { position: absolute; width: 50px; height: 50px; background: white; border: 2px solid #bdc3c7; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 20px; font-weight: bold; color: #2c3e50; }
        .face-1 { transform: rotateY(0deg) translateZ(25px); }
        .face-6 { transform: rotateY(180deg) translateZ(25px); }
        .face-2 { transform: rotateY(-90deg) translateZ(25px); }
        .face-5 { transform: rotateY(90deg) translateZ(25px); }
        .face-3 { transform: rotateX(90deg) translateZ(25px); }
        .face-4 { transform: rotateX(-90deg) translateZ(25px); }
        .face-1::after { content: "â—"; color: #e74c3c; font-size: 24px;} 
        .face-2::after { content: "2"; } .face-3::after { content: "3"; }
        .face-4::after { content: "4"; } .face-5::after { content: "5"; }
        .face-6::after { content: "6"; }

        .roll-btn {
            background: linear-gradient(to bottom, #e67e22, #d35400); color: white; border: none; padding: 10px 0; width: 90%; font-size: 16px; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #a04000; margin-top: 70px;
        }
        .roll-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 #a04000; }
        .roll-btn:disabled { background: #95a5a6; cursor: not-allowed; box-shadow: none; transform: translateY(3px); }

        /* --- å³ä¾§æ£‹ç›˜ (6x6) --- */
        #board {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 8px;
            position: relative;
            padding: 10px;
            background: #dfe6e9;
            border-radius: 12px;
            border: 1px solid #bdc3c7;
            height: 100%; box-sizing: border-box;
        }

        .cell {
            background: var(--cell-bg);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            position: relative;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 2px 0 #cbd5e0;
            padding: 2px;
            overflow: hidden;
            min-height: 0; 
        }

        .cell-icon { font-size: 20px; margin-bottom: 2px; line-height: 1; }
        .cell-name { font-size: 12px; color: #2c3e50; white-space: nowrap; }
        .cell-info { font-size: 9px; color: #7f8c8d; transform: scale(0.9); white-space: nowrap; }
        
        .t-start { background: #d4edda; border-bottom: 3px solid #28a745; }
        .t-city  { border-bottom: 3px solid #3498db; }
        .t-bad   { background: #fadbd8; border-bottom: 3px solid #c0392b; }
        .t-luck  { background: #fff3cd; border-bottom: 3px solid #f1c40f; }
        .t-fast  { background: #d6eaf8; border-bottom: 3px solid #85c1e9; }
        .t-school{ background: #e8daef; border-bottom: 3px solid #af7ac5; }
        .t-risk  { background: #ebdef0; border-bottom: 3px solid #8e44ad; }

        .token-container {
            width: 30px; height: 50px; position: absolute; z-index: 20; transition: top 0.3s linear, left 0.3s linear; pointer-events: none; display: flex; justify-content: center; align-items: flex-end;
        }
        .character-sprite { font-size: 32px; line-height: 1; transform-origin: bottom center; transition: transform 0.2s; filter: drop-shadow(0 3px 2px rgba(0,0,0,0.3)); }
        @keyframes walk-anim { 0%, 100% { transform: translateY(0) scaleX(var(--face-dir, 1)); } 50% { transform: translateY(-8px) scaleX(var(--face-dir, 1)); } }
        .walking .character-sprite { animation: walk-anim 0.25s infinite; }

        .center-area {
            grid-column: 2 / 6; grid-row: 2 / 6; background: #fff; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; box-shadow: inset 0 0 15px #eee; padding: 10px;
        }

        /* --- å¼¹çª—ä½“ç³» --- */
        .modal-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 100;
            justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-box {
            background: white; padding: 25px; border-radius: 15px; width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: popIn 0.3s ease;
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* å¼€å§‹æ¸¸æˆå¼¹çª— */
        .start-option {
            background: #f8f9fa; border: 2px solid #eee; padding: 15px; margin: 10px 0; border-radius: 10px; cursor: pointer; transition: 0.2s; text-align: left;
        }
        .start-option:hover, .start-option.selected { border-color: #3498db; background: #ebf5fb; }
        .start-option h4 { margin: 0 0 5px 0; color: #2c3e50; }
        .start-option p { margin: 0; font-size: 12px; color: #7f8c8d; }

        /* ç»“ç®—å¼¹çª— */
        .winner-trophy { font-size: 60px; margin-bottom: 10px; display:block; animation: float 2s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .stat-result { display: flex; justify-content: space-between; margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 8px; font-weight: bold; }

        /* æ§ä»¶ */
        .btn-main { background: #27ae60; color: white; width: 100%; padding: 12px; border:none; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold; margin-top: 10px;}
        input[type="range"] { width: 100%; margin: 15px 0; }
        .btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 15px; }
        .btn-opt { padding: 6px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer; color: white; background: #95a5a6; }
        .trade-info { background: #f8f9fa; padding: 10px; border-radius: 8px; margin: 10px 0; text-align: left; }

    </style>
</head>
<body>

<div id="game-container">
    <!-- å·¦ä¾§ -->
    <div id="control-panel">
        <div class="game-status">
            <div style="display:flex; justify-content:space-between;">
                <span>ğŸ¯ ç›®æ ‡: <span id="goal-text">50,000</span></span>
                <span id="turn-text">Round: 1</span>
            </div>
            <div class="progress-bar-bg" title="P1è¿›åº¦">
                <div id="p1-progress" class="progress-bar-fill" style="background:var(--p1-color)"></div>
            </div>
            <div class="progress-bar-bg" title="P2è¿›åº¦">
                <div id="p2-progress" class="progress-bar-fill" style="background:var(--p2-color)"></div>
            </div>
        </div>
        
        <div id="p1-card" class="player-card active">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <span>ğŸ‘¨â€ğŸ’¼ çˆ¸çˆ¸</span>
                <span id="p1-money" class="money-display">10000</span>
            </div>
            <div id="p1-buff" style="font-size:10px; color:#8e44ad; height:12px;"></div>
        </div>

        <div id="p2-card" class="player-card">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <span>ğŸ‘§ å¥³å„¿</span>
                <span id="p2-money" class="money-display">10000</span>
            </div>
            <div id="p2-buff" style="font-size:10px; color:#8e44ad; height:12px;"></div>
        </div>

        <div id="log-box"></div>

        <div id="action-area">
            <div class="cube-wrapper">
                <div class="cube" id="dice-cube">
                    <div class="cube-face face-1"></div>
                    <div class="cube-face face-2"></div>
                    <div class="cube-face face-3"></div>
                    <div class="cube-face face-4"></div>
                    <div class="cube-face face-5"></div>
                    <div class="cube-face face-6"></div>
                </div>
            </div>
            <button class="roll-btn" id="roll-btn" onclick="rollDice()">ğŸ² æ·éª°å­</button>
        </div>
    </div>

    <!-- å³ä¾§ -->
    <div id="board">
        <div class="center-area">
            <h3>ğŸ“ˆ å‡¯åˆ©å…¬å¼</h3>
            <div style="background:#2c3e50; color:#fff; padding:5px 15px; border-radius:15px; font-family:monospace; margin:5px 0;">f* = 2p - 1</div>
            <div style="font-size:11px; text-align:left; color:#555; line-height:1.6;">
                <p>ğŸ’¡ <b>æŠ•èµ„ç§˜è¯€ï¼š</b><br>èƒœç‡é«˜æ—¶å¤šæŠ•ï¼Œèƒœç‡ä½æ—¶åˆ«ç¢°ã€‚</p>
                <p>ğŸ <b>èƒœåˆ©æ¡ä»¶ï¼š</b><br><span id="win-condition-desc">å…ˆèµšåˆ° 50,000 å…ƒ</span></p>
            </div>
        </div>
        <div id="p1-token" class="token-container"><div class="character-sprite">ğŸ‘¨â€ğŸ’¼</div></div>
        <div id="p2-token" class="token-container"><div class="character-sprite">ğŸ‘§</div></div>
    </div>
</div>

<!-- å¼€å±€è®¾ç½®å¼¹çª— -->
<div id="modal-start" class="modal-overlay" style="display:flex;">
    <div class="modal-box">
        <h2>ğŸ® æ¸¸æˆè®¾ç½®</h2>
        <div class="start-option selected" onclick="selectMode(1, this)">
            <h4>ğŸ† ç«é€Ÿæ¨¡å¼ (æ¨è)</h4>
            <p>å…ˆèµšåˆ° <b>50,000</b> å…ƒçš„ç©å®¶è·èƒœã€‚</p>
        </div>
        <div class="start-option" onclick="selectMode(2, this)">
            <h4>â±ï¸ é™æ—¶æ¨¡å¼</h4>
            <p>è¿›è¡Œ <b>20</b> ä¸ªå›åˆï¼Œæœ€åé’±å¤šè€…èƒœã€‚</p>
        </div>
        <div class="start-option" onclick="selectMode(3, this)">
            <h4>ğŸ¢ æŒä¹…æˆ˜</h4>
            <p>ç›´åˆ°ä¸€æ–¹ç ´äº§ä¸ºæ­¢ã€‚</p>
        </div>
        <button class="btn-main" onclick="startGame()">ğŸš€ å¼€å§‹æ¸¸æˆ</button>
    </div>
</div>

<!-- æ¸¸æˆç»“æŸå¼¹çª— -->
<div id="modal-end" class="modal-overlay">
    <div class="modal-box" style="border-top: 5px solid #f1c40f;">
        <span class="winner-trophy">ğŸ†</span>
        <h2 id="end-title" style="margin:5px 0; color:#e67e22;">æ¸¸æˆç»“æŸ!</h2>
        <p id="end-reason" style="color:#7f8c8d;">è¾¾æˆç›®æ ‡é‡‘é¢</p>
        
        <div style="margin-top:20px;">
            <div class="stat-result" style="border-left:5px solid var(--p1-color)">
                <span>ğŸ‘¨â€ğŸ’¼ çˆ¸çˆ¸</span>
                <span id="end-p1-money">0</span>
            </div>
            <div class="stat-result" style="border-left:5px solid var(--p2-color)">
                <span>ğŸ‘§ å¥³å„¿</span>
                <span id="end-p2-money">0</span>
            </div>
        </div>

        <h3 id="winner-name" style="color:#27ae60; margin-top:15px;">ğŸ‰ çˆ¸çˆ¸ è·èƒœ!</h3>
        <button class="btn-main" onclick="location.reload()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
    </div>
</div>

<!-- äº¤æ˜“å¼¹çª— -->
<div id="modal-trade" class="modal-overlay">
    <div class="modal-box">
        <h3 id="trade-title" style="margin:0;">åŸå¸‚</h3>
        <div class="trade-info">
            <div style="display:flex; justify-content:space-between;">
                <span>ğŸ“ˆ èƒœç‡: <b id="trade-prob" style="color:#e67e22;">0%</b></span>
                <span style="font-size:12px; color:#999">ç›ˆäº Â±100%</span>
            </div>
            <div style="width:100%; height:6px; background:#ddd; margin-top:5px; border-radius:3px;">
                <div id="prob-bar" style="width:0%; height:100%; background:#e67e22; transition:width 0.5s;"></div>
            </div>
        </div>
        <div id="trade-input-ui">
            <p style="margin:5px 0; font-size:12px;">æŠ•å…¥é‡‘é¢: <b id="invest-val" style="font-size:16px;">0</b></p>
            <input type="range" id="invest-range" value="0" min="0" oninput="updateRangeUI()">
            <div class="btn-grid">
                <button class="btn-opt" style="background:#3498db" onclick="setInvest(0.1)">10%</button>
                <button class="btn-opt" style="background:#3498db" onclick="setInvest(0.2)">20%</button>
                <button class="btn-opt" style="background:#9b59b6" onclick="setInvest(0.5)">50%</button>
                <button class="btn-opt" style="background:#e74c3c" onclick="setInvest(1.0)">All</button>
            </div>
            <button class="btn-main" onclick="confirmTrade()">ğŸ’° ç¡®è®¤æŠ•èµ„</button>
        </div>
        <div id="trade-result"></div>
    </div>
</div>

<!-- ä¿¡æ¯å¼¹çª— -->
<div id="modal-info" class="modal-overlay">
    <div class="modal-box">
        <div id="info-icon" style="font-size:40px; margin-bottom:10px;">ğŸ</div>
        <h3 id="info-title">æ ‡é¢˜</h3>
        <p id="info-desc" style="font-size:14px; color:#555; margin:15px 0;">å†…å®¹</p>
        <button class="btn-main" onclick="closeInfoModal()">ç¡®å®š</button>
    </div>
</div>

<script>
    // --- é…ç½®ä¸çŠ¶æ€ ---
    const pathMap = [
        {r:1, c:1}, {r:1, c:2}, {r:1, c:3}, {r:1, c:4}, {r:1, c:5}, {r:1, c:6},
        {r:2, c:6}, {r:3, c:6}, {r:4, c:6}, {r:5, c:6}, {r:6, c:6},
        {r:6, c:5}, {r:6, c:4}, {r:6, c:3}, {r:6, c:2}, {r:6, c:1},
        {r:5, c:1}, {r:4, c:1}, {r:3, c:1}, {r:2, c:1}
    ];
    const mapData = [
        { name: "èµ·ç‚¹", type: "t-start", icon: "ğŸš©", info: "å·¥èµ„+2000" },
        { name: "å“ˆå°”æ»¨", type: "t-city", icon: "ğŸŒ¾", industry: "å†œä¸š", minP:0.52, maxP:0.60 },
        { name: "é›„å®‰", type: "t-city", icon: "ğŸ—ï¸", industry: "åŸºå»º", minP:0.65, maxP:0.75 },
        { name: "åŒ—äº¬", type: "t-city", icon: "ğŸ›ï¸", industry: "ç§‘æŠ€", minP:0.60, maxP:0.80 },
        { name: "åŒ»é™¢", type: "t-bad", icon: "ğŸ¥", info: "åŒ»è¯è´¹-1000" },
        { name: "é¦™æ¸¯", type: "t-risk", icon: "ğŸ‡­ğŸ‡°", industry: "é‡‘è", minP:0.50, maxP:0.90 },
        { name: "ä¸Šæµ·", type: "t-city", icon: "ğŸ™ï¸", industry: "é“¶è¡Œ", minP:0.65, maxP:0.85 },
        { name: "æ¾³é—¨", type: "t-luck", icon: "ğŸ°", info: "åšå½©" },
        { name: "æ­å·", type: "t-city", icon: "ğŸ›’", industry: "ç”µå•†", minP:0.60, maxP:0.80 },
        { name: "å°æ¹¾", type: "t-city", icon: "ğŸ‡¹ğŸ‡¼", industry: "èŠ¯ç‰‡", minP:0.60, maxP:0.88 },
        { name: "ç†”æ–­", type: "t-bad", icon: "ğŸ“‰", info: "èµ„äº§å†»ç»“-5%" },
        { name: "æ·±åœ³", type: "t-city", icon: "ğŸ’»", industry: "åˆ›æ–°", minP:0.60, maxP:0.90 },
        { name: "å¹¿å·", type: "t-city", icon: "ğŸµ", industry: "è´¸æ˜“", minP:0.60, maxP:0.80 },
        { name: "é«˜é“ç«™", type: "t-fast", icon: "ğŸš…", info: "é£è·ƒ5æ ¼" },
        { name: "å•†å­¦é™¢", type: "t-school", icon: "ğŸ“", info: "èƒœç‡UP" },
        { name: "æµ·å—", type: "t-city", icon: "ğŸï¸", industry: "å…ç¨", minP:0.55, maxP:0.80 },
        { name: "æˆéƒ½", type: "t-city", icon: "ğŸ¼", industry: "æ¶ˆè´¹", minP:0.55, maxP:0.75 },
        { name: "æ­¦æ±‰", type: "t-city", icon: "ğŸ§¬", industry: "åŒ»è¯", minP:0.55, maxP:0.75 },
        { name: "ç¨åŠ¡å±€", type: "t-bad", icon: "ğŸ‘®", info: "å¾ç¨10%" },
        { name: "è¥¿å®‰", type: "t-city", icon: "ğŸš€", industry: "å†›å·¥", minP:0.60, maxP:0.75 }
    ];

    let players = [
        { id:0, name:"çˆ¸çˆ¸", money:10000, pos:0, el:null, card:null, buff:0 },
        { id:1, name:"å¥³å„¿", money:10000, pos:0, el:null, card:null, buff:0 }
    ];
    let turn = 0;
    let roundCount = 1;
    let isAnimating = false;
    let currentDiceRot = {x:0, y:0};
    let currentTrade = null;

    // æ¸¸æˆè§„åˆ™è®¾ç½®
    let gameMode = 1; // 1: Money Target, 2: Turn Limit, 3: Bankruptcy
    let targetMoney = 50000;
    let maxRounds = 20;

    // --- å¼€å±€é€»è¾‘ ---
    function selectMode(mode, el) {
        gameMode = mode;
        document.querySelectorAll('.start-option').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
    }

    function startGame() {
        document.getElementById('modal-start').style.display = 'none';
        initBoard();
        
        let conditionText = "";
        let goalText = "";
        
        if (gameMode === 1) {
            conditionText = `å…ˆèµšåˆ° ${targetMoney.toLocaleString()} å…ƒ`;
            goalText = `ğŸ† ${targetMoney}`;
        } else if (gameMode === 2) {
            conditionText = `è¿›è¡Œ ${maxRounds} å›åˆ`;
            goalText = `â±ï¸ ${maxRounds} R`;
        } else {
            conditionText = "ç›´åˆ°ä¸€æ–¹ç ´äº§";
            goalText = "ğŸ’€ ç”Ÿå­˜";
        }
        
        document.getElementById('win-condition-desc').innerText = conditionText;
        document.getElementById('goal-text').innerText = goalText;
        updateStatus();
    }

    function initBoard() {
        const board = document.getElementById('board');
        
        // --- æ ¸å¿ƒä¿®å¤ï¼šä¿å­˜DOMå¼•ç”¨ï¼Œæ¸…ç†åå†æ”¾å›å» ---
        const decor = board.querySelector('.center-area');
        const p1Token = document.getElementById('p1-token');
        const p2Token = document.getElementById('p2-token');
        
        // ç»‘å®šå¼•ç”¨
        players[0].el = p1Token;
        players[1].el = p2Token;
        players[0].card = document.getElementById('p1-card');
        players[1].card = document.getElementById('p2-card');

        // æ¸…ç†æ£‹ç›˜ (ç§»é™¤æ—§æ ¼å­)
        board.innerHTML = '';
        
        // æ”¾å›æ ¸å¿ƒç»„ä»¶
        board.appendChild(decor);
        board.appendChild(p1Token);
        board.appendChild(p2Token);

        // ç”Ÿæˆæ–°æ ¼å­
        mapData.forEach((d, i) => {
            let div = document.createElement('div');
            div.className = `cell ${d.type}`;
            div.style.gridRow = pathMap[i].r;
            div.style.gridColumn = pathMap[i].c;
            div.innerHTML = `<div class="cell-icon">${d.icon}</div><div class="cell-name">${d.name}</div><div class="cell-info">${d.industry || d.info}</div>`;
            board.appendChild(div);
        });

        // é‡æ–°å®šä½
        setTimeout(() => {
            placePlayer(players[0], 0, false);
            placePlayer(players[1], 0, false);
        }, 100);
        
        log("æ¸¸æˆå¼€å§‹ï¼ç¥ä½ å¥½è¿ã€‚", "#2c3e50");
    }

    // --- æ¸¸æˆæµç¨‹ ---
    function rollDice() {
        if(isAnimating) return;
        isAnimating = true;
        document.getElementById('roll-btn').disabled = true;

        const val = Math.floor(Math.random()*6)+1;
        const diceFaces = [{x:0, y:0}, {x:0, y:-90}, {x:-90, y:0}, {x:90, y:0}, {x:0, y:90}, {x:0, y:180}];
        const target = diceFaces[val-1];
        
        let nextX = currentDiceRot.x + 720; 
        nextX += (target.x - (nextX % 360));
        let nextY = currentDiceRot.y + 720;
        nextY += (target.y - (nextY % 360));
        currentDiceRot = {x: nextX, y: nextY};
        
        const cube = document.getElementById('dice-cube');
        cube.style.transform = `rotateX(${nextX}deg) rotateY(${nextY}deg)`;

        log(`${players[turn].name} æ·å‡ºäº†...`);
        setTimeout(() => {
            log(`ğŸ² ç‚¹æ•°: <b>${val}</b>`);
            moveStep(players[turn], val);
        }, 1300);
    }

    function moveStep(p, steps) {
        let left = steps;
        p.el.classList.add('walking');
        let timer = setInterval(() => {
            let next = (p.pos + 1) % 20;
            if(next === 0 && p.pos === 19) {
                p.money += 2000;
                log(`ğŸ”„ ç»è¿‡èµ·ç‚¹ï¼Œå·¥èµ„+2000`, 'green');
                updateUI();
            }
            placePlayer(p, next, true);
            left--;
            if(left <= 0) {
                clearInterval(timer);
                p.el.classList.remove('walking');
                setTimeout(() => handleEvent(p), 300);
            }
        }, 250);
    }

    function placePlayer(p, idx, anim) {
        p.pos = idx;
        const cells = document.querySelectorAll('.cell');
        // ç”±äºDOMç»“æ„å˜åŒ–ï¼Œcellsç´¢å¼•éœ€è¦æ³¨æ„ã€‚
        // .cell æ˜¯è¿½åŠ åˆ°æœ€åçš„ï¼Œæ‰€ä»¥ indices 0-19 å¯¹åº” mapData
        // ä½†æ˜¯ querySelectorAll ä¼šæŒ‰æ–‡æ¡£é¡ºåºæ‰¾ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ .cell éƒ½åœ¨ tokens åé¢æˆ–æ­£ç¡®é¡ºåº
        // initBoard é‡Œæ˜¯å…ˆåŠ  tokens å†åŠ  cellsï¼Œæ‰€ä»¥ cells[idx] åº”è¯¥æ²¡é—®é¢˜ã€‚
        if(idx >= cells.length) return; // safety
        
        const cell = cells[idx];
        const cellRect = cell.getBoundingClientRect();
        const boardRect = document.getElementById('board').getBoundingClientRect();
        let cx = cellRect.left - boardRect.left + cellRect.width/2;
        let cy = cellRect.top - boardRect.top + cellRect.height/2;

        if(p.id===0) { cx -= 12; cy -= 5; } else { cx += 12; cy += 5; }
        if(anim) {
            let currC = pathMap[idx].c;
            let prevPos = (idx - 1 + 20) % 20;
            let prevC = pathMap[prevPos].c;
            if (currC > prevC) p.el.style.setProperty('--face-dir', 1);
            else if(currC < prevC) p.el.style.setProperty('--face-dir', -1);
        }
        p.el.style.left = (cx - 15) + 'px';
        p.el.style.top = (cy - 45) + 'px';
    }

    function handleEvent(p) {
        const d = mapData[p.pos];
        log(`${p.name} åˆ°è¾¾ ${d.name}`);

        if(d.type === 't-city' || d.type === 't-risk') {
            openTradeModal(d, p);
        } else if(d.name === "æ¾³é—¨") {
            if(Math.random()>0.5) { let w=1000; p.money+=w; showInfo("ğŸ° æ¾³é—¨é£äº‘", "æ‰‹æ°”ä¸é”™ï¼èµ¢äº† "+w, "ğŸ’°"); } 
            else { let l=500; p.money-=l; showInfo("ğŸ° æ¾³é—¨é£äº‘", "æ‰‹æ°”ä¸ä½³ï¼Œè¾“äº† "+l, "ğŸ’¸"); }
            updateUI();
        } else if(d.name === "é«˜é“ç«™") {
            log("ğŸš… åé«˜é“ï¼Œå‰è¿›5æ ¼ï¼", 'blue'); moveStep(p, 5); return;
        } else if(d.name === "åŒ»é™¢") {
            let c=1000; p.money-=c; updateUI(); showInfo("ğŸš‘ åŒ»é™¢", "çœ‹ç—…èŠ±è´¹ "+c, "ğŸ’‰");
        } else if(d.name === "ç†”æ–­") {
            let c=Math.floor(p.money*0.05); p.money-=c; updateUI(); showInfo("ğŸ“‰ å¸‚åœºç†”æ–­", "èµ„äº§ç¼©æ°´ "+c, "â„ï¸");
        } else if(d.name === "ç¨åŠ¡å±€") {
            let t=Math.floor(p.money*0.1); p.money-=t; updateUI(); showInfo("ğŸ‘® ç¨åŠ¡ç¨½æŸ¥", "çº³ç¨ "+t, "ğŸ§¾");
        } else if(d.name === "å•†å­¦é™¢") {
            p.money-=500; p.buff=0.15; updateUI(); document.getElementById(p.id===0?'p1-buff':'p2-buff').innerText="Buff: èƒœç‡+15%";
            showInfo("ğŸ“ EMBAè¿›ä¿®", "ä¸‹æ¬¡èƒœç‡+15%", "ğŸ“š");
        } else {
            nextTurn();
        }
    }

    // --- äº¤æ˜“ç³»ç»Ÿ ---
    function openTradeModal(data, p) {
        currentTrade = { p: p, baseP: (Math.random()*(data.maxP-data.minP)+data.minP) };
        let finalP = currentTrade.baseP + p.buff;
        if(finalP > 0.95) finalP = 0.95;
        currentTrade.finalP = finalP;

        const modal = document.getElementById('modal-trade');
        document.getElementById('trade-title').innerText = `${data.name} Â· ${data.industry}`;
        let pct = Math.round(finalP*100);
        document.getElementById('trade-prob').innerText = `${pct}%`;
        document.getElementById('prob-bar').style.width = `${pct}%`;

        const range = document.getElementById('invest-range');
        range.max = Math.floor(p.money); range.value = 0;
        updateRangeUI();
        document.getElementById('trade-input-ui').style.display = 'block';
        document.getElementById('trade-result').innerHTML = '';
        modal.style.display = 'flex';
    }

    function updateRangeUI() { document.getElementById('invest-val').innerText = document.getElementById('invest-range').value; }
    function setInvest(r) { document.getElementById('invest-range').value = Math.floor(currentTrade.p.money * r); updateRangeUI(); }

    function confirmTrade() {
        const bet = parseInt(document.getElementById('invest-range').value);
        const p = currentTrade.p;
        if(p.buff > 0) { p.buff = 0; document.getElementById(p.id===0?'p1-buff':'p2-buff').innerText = ""; }
        document.getElementById('trade-input-ui').style.display = 'none';

        const win = Math.random() <= currentTrade.finalP;
        let html = '';
        if(win) {
            p.money += bet;
            html = `<div class="trade-info" style="border-left:5px solid #2ecc71;"><b>ğŸ“ˆ æŠ•èµ„æˆåŠŸ</b><br>ç›ˆåˆ© +${bet}</div>`;
            log(`ç›ˆåˆ© ${bet}`, 'green');
        } else {
            p.money -= bet;
            html = `<div class="trade-info" style="border-left:5px solid #e74c3c;"><b>ğŸ“‰ æŠ•èµ„å¤±è´¥</b><br>äºæŸ -${bet}</div>`;
            log(`äºæŸ ${bet}`, 'red');
        }
        
        // Kelly
        let k = (2 * currentTrade.finalP) - 1;
        html += `<div style="font-size:12px;color:#555;margin-top:5px;">å»ºè®®ä»“ä½: <b>${Math.max(0, Math.round(k*100))}%</b></div>`;
        html += `<button class="btn-main" onclick="closeTrade()" style="padding:8px; margin-top:10px;">å®Œæˆ</button>`;
        document.getElementById('trade-result').innerHTML = html;
        updateUI();
    }

    function closeTrade() { document.getElementById('modal-trade').style.display = 'none'; nextTurn(); }
    function showInfo(t, d, i) { document.getElementById('info-title').innerText=t; document.getElementById('info-desc').innerText=d; document.getElementById('info-icon').innerText=i; document.getElementById('modal-info').style.display='flex'; }
    function closeInfoModal() { document.getElementById('modal-info').style.display='none'; nextTurn(); }

    function updateUI() {
        document.getElementById('p1-money').innerText = Math.floor(players[0].money);
        document.getElementById('p2-money').innerText = Math.floor(players[1].money);
        updateStatus();
    }

    function updateStatus() {
        // æ›´æ–°è¿›åº¦æ¡
        if(gameMode === 1) { // ç›®æ ‡é‡‘é¢
            let p1Pct = Math.min(100, (players[0].money / targetMoney) * 100);
            let p2Pct = Math.min(100, (players[1].money / targetMoney) * 100);
            document.getElementById('p1-progress').style.width = p1Pct + "%";
            document.getElementById('p2-progress').style.width = p2Pct + "%";
            document.getElementById('turn-text').innerText = "Round: " + roundCount;
        } else if(gameMode === 2) { // å›åˆé™åˆ¶
            let turnPct = Math.min(100, (roundCount / maxRounds) * 100);
            document.getElementById('p1-progress').style.width = turnPct + "%";
            document.getElementById('p2-progress').style.width = turnPct + "%";
            document.getElementById('turn-text').innerText = `Round: ${roundCount} / ${maxRounds}`;
        }
    }

    function log(msg, color='#333') {
        let div = document.createElement('div');
        div.innerHTML = msg; div.style.color = color;
        document.getElementById('log-box').prepend(div);
    }

    // --- èƒœåˆ©åˆ¤å®šä¸å›åˆç»“æŸ ---
    function nextTurn() {
        // æ£€æŸ¥å³æ—¶èƒœåˆ©/å¤±è´¥æ¡ä»¶
        if (checkGameOver()) return;

        players[turn].card.classList.remove('active');
        turn = (turn+1)%2;
        if(turn === 0) roundCount++; // å›åˆ°P1ç®—ä¸€è½®ç»“æŸ
        
        // æ£€æŸ¥å›åˆæ•°æ˜¯å¦è€—å°½ (ä»…åœ¨å›åˆå¼€å§‹æ—¶)
        if (gameMode === 2 && roundCount > maxRounds) {
            triggerGameOver("å›åˆç»“æŸ");
            return;
        }

        players[turn].card.classList.add('active');
        isAnimating = false;
        document.getElementById('roll-btn').disabled = false;
        log(`ğŸ‘‰ è½®åˆ° ${players[turn].name}`);
        updateStatus();
    }

    function checkGameOver() {
        // 1. ç ´äº§æ£€æŸ¥
        if (players[turn].money <= 0) {
            triggerGameOver("èµ„äº§è€—å°½ç ´äº§");
            return true;
        }
        // 2. ç›®æ ‡é‡‘é¢æ£€æŸ¥
        if (gameMode === 1 && players[turn].money >= targetMoney) {
            triggerGameOver("è¾¾æˆè´¢å¯Œç›®æ ‡");
            return true;
        }
        return false;
    }

    function triggerGameOver(reason) {
        document.getElementById('modal-end').style.display = 'flex';
        document.getElementById('end-reason').innerText = `ç»“æŸåŸå› : ${reason}`;
        document.getElementById('end-p1-money').innerText = Math.floor(players[0].money);
        document.getElementById('end-p2-money').innerText = Math.floor(players[1].money);
        
        let winnerName = "";
        if (players[0].money > players[1].money) winnerName = "ğŸ‘¨â€ğŸ’¼ çˆ¸çˆ¸ è·èƒœ!";
        else if (players[1].money > players[0].money) winnerName = "ğŸ‘§ å¥³å„¿ è·èƒœ!";
        else winnerName = "ğŸ¤ å¹³å±€!";
        
        document.getElementById('winner-name').innerText = "ğŸ‰ " + winnerName;
    }

    window.onload = function() {
        // åˆå§‹æ—¶ä¸åŠ è½½åœ°å›¾ï¼Œç­‰ç‚¹å‡»å¼€å§‹æ¸¸æˆååŠ è½½
    };
</script>
</body>
</html>