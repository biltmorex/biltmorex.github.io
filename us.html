<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾è‚¡å›æ’¤è®¡ç®—å™¨ (æ–°æµª/è…¾è®¯ + æ—¶é—´é€‰æ‹©)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Microsoft YaHei", sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        
        h2 { text-align: center; margin-top: 0; color: #333; margin-bottom: 25px; }

        /* æ§åˆ¶æ  */
        .control-bar {
            background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;
            border: 1px solid #eee; display: flex; flex-direction: column; align-items: center; gap: 15px;
        }

        .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; }

        select {
            padding: 10px 15px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; font-weight: bold; color: #555; cursor: pointer;
        }

        button {
            padding: 10px 18px; font-size: 14px; font-weight: bold; color: #fff; border: none; border-radius: 6px; cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
        }
        button:active { transform: scale(0.98); }
        button:hover { opacity: 0.9; }
        
        .btn-sina { background: #d81e06; box-shadow: 0 2px 5px rgba(216, 30, 6, 0.2); }
        .btn-qq { background: #1296db; box-shadow: 0 2px 5px rgba(18, 150, 219, 0.2); }

        .status-msg { font-size: 13px; color: #666; height: 20px; text-align: center; }

        /* æ•°æ®å±•ç¤º */
        .stats { display: flex; justify-content: space-between; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .stat-item { 
            text-align: center; background: #fff; padding: 15px; border-radius: 10px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); flex: 1; min-width: 140px; border: 1px solid #f0f0f0;
        }
        .stat-label { font-size: 13px; color: #888; margin-bottom: 5px; }
        .stat-val { font-size: 22px; font-weight: bold; color: #333; }
        .red { color: #d0021b; } .green { color: #179c17; }

        .chart-area { position: relative; height: 450px; width: 100%; margin-bottom: 20px; }
        
        #debug-log {
            font-size: 12px; color: #999; border-top: 1px solid #eee; padding-top: 10px; height: 60px; overflow-y: auto; font-family: monospace;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“ˆ ç¾è‚¡æŒ‡æ•°å›æ’¤åˆ†æ</h2>
    
    <div class="control-bar">
        <div class="row">
            <span style="font-weight:bold;">1. æ—¶é—´èŒƒå›´:</span>
            <select id="timeRange">
                <option value="250">æœ€è¿‘ 1 å¹´</option>
                <option value="1250" selected>æœ€è¿‘ 5 å¹´ (æ¨è)</option>
                <option value="2500">æœ€è¿‘ 10 å¹´</option>
                <option value="max">å…¨å†å²æ•°æ®</option>
            </select>
        </div>
        
        <div style="width: 100%; height: 1px; background: #eee;"></div>

        <div class="row">
            <span style="font-weight:bold;">2. æ–°æµªæº (é¦–é€‰):</span>
            <button class="btn-sina" onclick="loadData('SINA', 'SPX')">æ ‡æ™®500</button>
            <button class="btn-sina" onclick="loadData('SINA', 'NDX')">çº³æŒ‡100</button>
            <button class="btn-sina" onclick="loadData('SINA', 'IXIC')">çº³æŒ‡ç»¼åˆ</button>
            <button class="btn-sina" onclick="loadData('SINA', 'DJI')">é“ç¼æ–¯</button>
        </div>
        <div class="row">
            <span style="font-weight:bold;">3. è…¾è®¯æº (å¤‡ç”¨):</span>
            <button class="btn-qq" onclick="loadData('TENCENT', 'IXIC')">çº³æŒ‡ç»¼åˆ</button>
            <button class="btn-qq" onclick="loadData('TENCENT', 'DJI')">é“ç¼æ–¯</button>
        </div>
    </div>

    <div class="status-msg" id="statusMsg">å‡†å¤‡å°±ç»ª</div>

    <div class="stats">
        <div class="stat-item">
            <div class="stat-label">æœ€æ–°æ”¶ç›˜ä»·</div>
            <div class="stat-val" id="val-price">-</div>
            <div class="stat-label" id="val-date" style="font-size:11px; margin-top:3px;">-</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">åŒºé—´æœ€é«˜ç‚¹</div>
            <div class="stat-val" id="val-high">-</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">å½“å‰å›æ’¤</div>
            <div class="stat-val red" id="val-dd">-</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">åŒºé—´æœ€å¤§å›æ’¤</div>
            <div class="stat-val red" id="val-max-dd">-</div>
        </div>
    </div>

    <div class="chart-area">
        <canvas id="myChart"></canvas>
    </div>

    <div id="debug-log">è¿è¡Œæ—¥å¿—...</div>
</div>

<script>
    let myChart = null;
    
    function log(msg) {
        const box = document.getElementById('debug-log');
        box.innerHTML = `> ${msg}<br>` + box.innerHTML;
        console.log(msg);
    }

    const CONFIG = {
        SINA: {
            SPX: { symbol: '.INX', name: 'æ ‡æ™®500' },
            NDX: { symbol: '.NDX', name: 'çº³æŒ‡100' },
            IXIC: { symbol: '.IXIC', name: 'çº³æŒ‡ç»¼åˆ' },
            DJI: { symbol: '.DJI', name: 'é“ç¼æ–¯' }
        },
        TENCENT: {
            IXIC: { symbol: 'us.IXIC', name: 'çº³æŒ‡ç»¼åˆ' },
            DJI: { symbol: 'us.DJI', name: 'é“ç¼æ–¯' }
        }
    };

    function loadData(source, type) {
        const status = document.getElementById('statusMsg');
        const range = document.getElementById('timeRange').value;
        const rangeText = document.getElementById('timeRange').options[document.getElementById('timeRange').selectedIndex].text;
        
        status.innerText = `æ­£åœ¨è¿æ¥ ${source} è·å– ${CONFIG[source][type].name} (${rangeText})...`;
        status.style.color = source === 'SINA' ? '#d81e06' : '#1296db';
        
        log(`å¼€å§‹è¯·æ±‚: ${source} - ${type}, èŒƒå›´: ${range}`);

        if (source === 'SINA') {
            loadSina(CONFIG.SINA[type], range);
        } else {
            loadTencent(CONFIG.TENCENT[type], range);
        }
    }

    // --- æ–°æµªåŠ è½½é€»è¾‘ ---
    function loadSina(item, range) {
        const varName = `sina_${Date.now()}`;
        // æ–°æµªAPIä¸æ”¯æŒç›´æ¥limitï¼Œæ‰€ä»¥æˆ‘ä»¬è¯·æ±‚å…¨é‡ï¼Œç„¶ååœ¨å‰ç«¯æˆªå–
        const url = `https://stock.finance.sina.com.cn/usstock/api/jsonp_v2.php/window.${varName}=/US_MinKService.getDailyK?symbol=${item.symbol}&___=${Math.random()}`;
        
        const script = document.createElement('script');
        script.src = url;
        
        script.onload = () => {
            const data = window[varName];
            if (data && Array.isArray(data)) {
                // 1. æ’åºï¼šç¡®ä¿æŒ‰æ—¥æœŸä»æ—§åˆ°æ–°
                data.sort((a, b) => new Date(a.d) - new Date(b.d));

                // 2. æ ¹æ®æ—¶é—´èŒƒå›´æˆªå–æ•°æ® (Client-side slicing)
                let slicedData = data;
                if (range !== 'max') {
                    const limit = parseInt(range);
                    if (data.length > limit) {
                        slicedData = data.slice(-limit);
                    }
                }

                let dates = [], prices = [], highs = [];
                slicedData.forEach(k => {
                    dates.push(k.d);
                    prices.push(parseFloat(k.c));
                    highs.push(parseFloat(k.h));
                });

                log(`æ–°æµª: è·å–å…¨é‡æ•°æ® ${data.length} æ¡ï¼Œæˆªå–åå‰©ä½™ ${slicedData.length} æ¡`);
                calculateAndDraw(dates, prices, highs, item.name + " (æ–°æµª)");
                delete window[varName];
                document.body.removeChild(script);
            } else {
                alert("æ–°æµªè¿”å›æ•°æ®ä¸ºç©º");
            }
        };
        script.onerror = () => { alert("æ–°æµªè¿æ¥å¤±è´¥"); document.body.removeChild(script); };
        document.body.appendChild(script);
    }

    // --- è…¾è®¯åŠ è½½é€»è¾‘ ---
    function loadTencent(item, range) {
        const varName = `v_${Date.now()}`;
        // è…¾è®¯æ”¯æŒ limit å‚æ•°: param=ä»£ç ,day,,,æ•°é‡,qfq
        // å¦‚æœæ˜¯ maxï¼Œæˆ‘ä»¬ä¼ ä¸€ä¸ªå¾ˆå¤§çš„æ•°
        const limitParam = (range === 'max') ? 100000 : range;
        
        const url = `https://web.ifzq.gtimg.cn/appstock/app/fqkline/get?_var=${varName}&param=${item.symbol},day,,,${limitParam},qfq`;

        const script = document.createElement('script');
        script.src = url;

        script.onload = () => {
            const res = window[varName];
            if (res && res.data && res.data[item.symbol]) {
                const dayData = res.data[item.symbol].day || res.data[item.symbol].qfqday;
                
                let dates = [], prices = [], highs = [];
                dayData.forEach(item => {
                    let d = item[0]; // 20230101
                    let dateStr = `${d.substring(0,4)}-${d.substring(4,6)}-${d.substring(6,8)}`;
                    dates.push(dateStr);
                    prices.push(parseFloat(item[2]));
                    highs.push(parseFloat(item[3]));
                });

                log(`è…¾è®¯: æˆåŠŸè·å– ${prices.length} æ¡æ•°æ®`);
                calculateAndDraw(dates, prices, highs, item.name + " (è…¾è®¯)");
                delete window[varName];
                document.body.removeChild(script);
            } else {
                alert("è…¾è®¯æ•°æ®æ ¼å¼å¼‚å¸¸");
            }
        };
        script.onerror = () => { alert("è…¾è®¯è¿æ¥å¤±è´¥"); document.body.removeChild(script); };
        document.body.appendChild(script);
    }

    // --- é€šç”¨è®¡ç®—ä¸ç»˜å›¾ ---
    function calculateAndDraw(dates, prices, highs, title) {
        document.getElementById('statusMsg').innerText = `âœ… æˆåŠŸåŠ è½½: ${title}`;
        
        let drawdowns = [];
        let runningMaxClose = -Infinity;
        let maxDD = 0;
        let trueMax = -Infinity;

        // è®¡ç®—ã€å½“å‰é€‰å®šèŒƒå›´å†…ã€‘çš„æœ€é«˜ç‚¹
        for (let h of highs) {
            if (h > trueMax) trueMax = h;
        }

        for (let p of prices) {
            if (p > runningMaxClose) runningMaxClose = p;
            let dd = ((p - runningMaxClose) / runningMaxClose) * 100;
            drawdowns.push(dd);
            if (dd < maxDD) maxDD = dd;
        }

        const last = prices.length - 1;

        // æ›´æ–°æ•°å€¼é¢æ¿
        document.getElementById('val-price').innerText = prices[last].toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('val-date').innerText = dates[last];
        document.getElementById('val-high').innerText = trueMax.toLocaleString(undefined, {minimumFractionDigits: 2});
        
        const currDD = drawdowns[last];
        const elDD = document.getElementById('val-dd');
        elDD.innerText = currDD.toFixed(2) + "%";
        elDD.style.color = currDD >= 0 ? '#179c17' : '#d0021b';
        
        document.getElementById('val-max-dd').innerText = maxDD.toFixed(2) + "%";

        // ç»˜å›¾
        const ctx = document.getElementById('myChart').getContext('2d');
        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'æŒ‡æ•°ç‚¹ä½',
                        data: prices,
                        borderColor: '#333',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        yAxisID: 'y1'
                    },
                    {
                        label: 'å›æ’¤ %',
                        data: drawdowns,
                        borderColor: '#d0021b',
                        backgroundColor: 'rgba(208, 2, 27, 0.1)',
                        borderWidth: 1,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        yAxisID: 'y'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    title: { display: true, text: title + ' èµ°åŠ¿ä¸å›æ’¤' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let val = context.parsed.y;
                                if (context.dataset.label.includes('å›æ’¤')) return `å›æ’¤: ${val.toFixed(2)}%`;
                                return `ä»·æ ¼: ${val.toFixed(2)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: { ticks: { maxTicksLimit: 10 } },
                    y: { 
                        type: 'linear', position: 'left', max: 5, 
                        title: { display: true, text: 'å›æ’¤å¹…åº¦ (%)' }
                    },
                    y1: { 
                        type: 'linear', position: 'right',
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    }
</script>

</body>
</html>