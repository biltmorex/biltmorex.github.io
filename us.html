<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美股指数回撤计算器 (含纳指100)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --primary: #007bff;
            --danger: #dc3545;
            --success: #28a745;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* 顶部控制栏 */
        .control-bar {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        select, button {
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 14px;
            border: 1px solid #ddd;
        }

        select { background-color: #fff; cursor: pointer; min-width: 120px; font-weight: bold;}
        
        button {
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:active { transform: scale(0.98); }
        button:hover { opacity: 0.9; }

        /* 按钮颜色区分 */
        .btn-spx { background-color: #0056b3; } /* 深蓝 */
        .btn-ixic { background-color: #6610f2; } /* 紫色 */
        .btn-ndx { background-color: #17a2b8; } /* 青色/湖蓝 */

        /* 状态提示 */
        .status-text { text-align: center; font-size: 13px; color: #666; margin-bottom: 15px; height: 20px;}

        /* 数据卡片 */
        .grid-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            border-bottom: 3px solid transparent;
        }
        
        /* 卡片底部装饰条 */
        .card:nth-child(1) { border-color: #ccc; }
        .card:nth-child(2) { border-color: var(--primary); }
        .card:nth-child(3) { border-color: var(--danger); }
        .card:nth-child(4) { border-color: var(--danger); }

        .card-label { font-size: 13px; color: #888; margin-bottom: 5px; }
        .card-value { font-size: 24px; font-weight: 700; color: #222; }
        .card-sub { font-size: 12px; color: #999; margin-top: 4px; }
        .val-red { color: var(--danger); }
        .val-green { color: var(--success); }

        /* 图表 */
        .chart-box {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            height: 500px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            position: relative;
        }

        /* 加载动画 */
        .loader {
            position: absolute; top:0; left:0; right:0; bottom:0;
            background: rgba(255,255,255,0.95);
            display: none;
            justify-content: center; align-items: center;
            flex-direction: column;
            z-index: 10;
            border-radius: 12px;
        }
        .spinner {
            width: 30px; height: 30px; border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color:#444; margin-bottom:20px;">指数回撤分析工具</h2>
    
    <div class="control-bar">
        <div>
            <span style="font-weight:bold; margin-right:5px; color:#555;">1. 时间范围:</span>
            <select id="timeRange">
                <option value="1y">最近 1 年 (日线-超精准)</option>
                <option value="5y" selected>最近 5 年 (日线-推荐)</option>
                <option value="10y">最近 10 年 (日线/周线)</option>
                <option value="max">全历史 (月线-看大周期)</option>
            </select>
        </div>
        <div style="border-left: 1px solid #ddd; height: 30px; margin: 0 5px;"></div>
        <div>
            <span style="font-weight:bold; margin-right:5px; color:#555;">2. 选择指数:</span>
            <button class="btn-spx" onclick="loadData('^GSPC', '标普500 (^GSPC)')">标普500</button>
            <button class="btn-ixic" onclick="loadData('^IXIC', '纳指综合 (^IXIC)')">纳指综合</button>
            <button class="btn-ndx" onclick="loadData('^NDX', '纳指100 (^NDX)')">纳指100</button>
        </div>
    </div>

    <div class="status-text" id="statusMsg">准备就绪。建议选择“最近5年”以获取精准高点数据。</div>

    <div class="grid-stats">
        <div class="card">
            <div class="card-label">最新收盘价</div>
            <div class="card-value" id="dispPrice">-</div>
            <div class="card-sub" id="dispDate">-</div>
        </div>
        <div class="card">
            <div class="card-label">期间最高点 (盘中)</div>
            <div class="card-value" id="dispHigh">-</div>
            <div class="card-sub">范围内的最高价</div>
        </div>
        <div class="card">
            <div class="card-label">当前回撤幅度</div>
            <div class="card-value val-red" id="dispDD">-</div>
        </div>
        <div class="card">
            <div class="card-label">期间最大回撤</div>
            <div class="card-value val-red" id="dispMaxDD">-</div>
        </div>
    </div>

    <div class="chart-box">
        <div class="loader" id="loader">
            <div class="spinner"></div>
            <div>正在从 Yahoo Finance 下载数据...</div>
        </div>
        <canvas id="myChart"></canvas>
    </div>
</div>

<script>
    let myChart = null;

    async function loadData(symbol, name) {
        const range = document.getElementById('timeRange').value;
        const loader = document.getElementById('loader');
        const statusMsg = document.getElementById('statusMsg');
        
        loader.style.display = 'flex';
        statusMsg.innerText = `正在请求 ${name} 的 ${range} 数据...`;

        // 动态设置间隔：全历史用月线防止数据丢失，5年/1年用日线保证精准
        let interval = '1d';
        if (range === 'max') interval = '1mo'; 
        if (range === '10y') interval = '1wk'; 

        const rand = Math.floor(Math.random() * 100000);
        const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=${range}&interval=${interval}&events=history&nocache=${rand}`;
        const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(yahooUrl);

        try {
            const response = await fetch(proxyUrl);
            if (!response.ok) throw new Error("网络连接超时或代理繁忙");
            
            const json = await response.json();
            
            if (!json.chart || !json.chart.result) throw new Error("Yahoo暂无该指数数据");
            
            const result = json.chart.result[0];
            const quotes = result.indicators.quote[0];
            const times = result.timestamp;

            if (!times || !quotes.close) throw new Error("数据包损坏，请重试");

            let dates = [];
            let prices = [];
            // 获取盘中最高价数组（如果可用），用于计算精准高点
            const highs = quotes.high || quotes.close; 

            for (let i = 0; i < times.length; i++) {
                if (quotes.close[i] != null) {
                    let d = new Date(times[i] * 1000);
                    // 格式化日期
                    dates.push(d.toISOString().split('T')[0]);
                    prices.push(parseFloat(quotes.close[i].toFixed(2)));
                }
            }

            // 计算真实的期间最高点（遍历 High 数组）
            let trueMax = -Infinity;
            for (let i = 0; i < times.length; i++) {
                if (highs[i] != null) {
                    let h = parseFloat(highs[i]);
                    if (h > trueMax) trueMax = h;
                }
            }

            statusMsg.innerText = `成功加载 ${name} 数据 (${prices.length} 条记录)`;
            
            calculateAndDraw(dates, prices, trueMax, name, range);

        } catch (err) {
            console.error(err);
            statusMsg.innerText = "❌ 错误: " + err.message;
            alert("数据获取失败，可能原因：\n1. 网络代理响应超时（请重试）\n2. 时间范围数据量过大");
        } finally {
            loader.style.display = 'none';
        }
    }

    function calculateAndDraw(dates, prices, trueMax, name, range) {
        let drawdowns = [];
        let runningMaxClose = -Infinity; // 用于计算回撤曲线的收盘高点
        let maxDD = 0;

        for (let p of prices) {
            if (p > runningMaxClose) runningMaxClose = p;
            let dd = ((p - runningMaxClose) / runningMaxClose) * 100;
            drawdowns.push(dd);
            if (dd < maxDD) maxDD = dd;
        }

        const lastIdx = prices.length - 1;
        
        // 1. 更新面板数值
        document.getElementById('dispPrice').innerText = prices[lastIdx].toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('dispDate').innerText = dates[lastIdx];
        
        // 显示期间盘中最高
        document.getElementById('dispHigh').innerText = trueMax.toLocaleString(undefined, {minimumFractionDigits: 2});
        
        // 2. 显示当前回撤
        const currDD = drawdowns[lastIdx];
        const elDD = document.getElementById('dispDD');
        elDD.innerText = currDD.toFixed(2) + "%";
        elDD.style.color = currDD >= 0 ? '#28a745' : '#dc3545';
        
        // 如果数据有点延迟，导致当前点比历史最高低，但回撤算出来是0（比如刚创新高），强行修正显示逻辑
        // 这里的 drawdowns 是基于收盘价计算的，如果基于盘中高点计算，可以用 (prices[lastIdx] - trueMax)/trueMax
        // 为了和图表对应，我们暂时保持图表逻辑（收盘价回撤）。

        document.getElementById('dispMaxDD').innerText = maxDD.toFixed(2) + "%";

        // 3. 绘图
        const ctx = document.getElementById('myChart').getContext('2d');
        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: '指数价格',
                        data: prices,
                        borderColor: '#007bff',
                        borderWidth: 1.5,
                        yAxisID: 'y1',
                        pointRadius: 0,
                        pointHoverRadius: 4
                    },
                    {
                        label: '回撤 %',
                        data: drawdowns,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.15)', // 浅红背景
                        borderWidth: 1,
                        fill: true,
                        yAxisID: 'y',
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    title: { display: true, text: `${name} - ${range} 走势图` },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let val = context.parsed.y;
                                if (context.dataset.label.includes('回撤')) return `回撤: ${val.toFixed(2)}%`;
                                return `价格: ${val.toFixed(2)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: { ticks: { maxTicksLimit: 10 } },
                    y: { 
                        type: 'linear', position: 'left', max: 5, 
                        title: {display:true, text:'回撤幅度 (%)'},
                        grid: { color: '#f0f0f0' }
                    },
                    y1: { 
                        type: 'linear', position: 'right',
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    }
</script>

</body>
</html>