<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡¯åˆ©å…¬å¼ä»¿çœŸäº¤æ˜“ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
        }

        @media (max-width: 800px) {
            .container { grid-template-columns: 1fr; }
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        h2, h3 { margin-top: 0; color: var(--text-main); }
        .label { font-size: 0.9rem; color: var(--text-sub); margin-bottom: 6px; display: block; font-weight: 500; }
        
        /* è¾“å…¥æ§ä»¶ */
        .input-group { margin-bottom: 20px; }
        input[type="number"], input[type="range"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* ç»“æœé¢æ¿ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-top: 5px;
        }
        .stat-value.green { color: var(--success); }
        .stat-value.red { color: var(--danger); }

        /* å»ºè®®ä¸‹æ³¨æ˜¾ç¤º */
        .recommendation {
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid rgba(37, 99, 235, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .rec-title { font-size: 0.9rem; color: var(--text-sub); }
        .rec-amount { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        .rec-percent { font-size: 1rem; color: var(--text-sub); margin-left: 5px; }

        /* æ“ä½œæŒ‰é’® */
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        button:active { transform: translateY(1px); }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-reset { background: #fee2e2; color: var(--danger); grid-column: span 2; }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            background: #fff;
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* å†å²è®°å½• */
        .history-log {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid var(--border);
            padding-top: 10px;
            font-size: 0.9rem;
        }
        .log-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .win { color: var(--success); }
        .loss { color: var(--danger); }

    </style>
</head>
<body>

<div class="container">
    <!-- å·¦ä¾§ï¼šè®¾ç½®ä¸æ§åˆ¶ -->
    <div class="card settings-panel">
        <h2>âš™ï¸ ç­–ç•¥å‚æ•°</h2>
        
        <div class="input-group">
            <label class="label">åˆå§‹æœ¬é‡‘ (Capital)</label>
            <input type="number" id="initialCapital" value="10000" onchange="resetGame()">
        </div>

        <div class="input-group">
            <label class="label">èƒœç‡ (Win Rate %)</label>
            <input type="number" id="winRate" value="55" min="1" max="99" oninput="updateCalculations()">
        </div>

        <div class="input-group">
            <label class="label">èµ”ç‡ (Decimal Odds)</label>
            <input type="number" id="odds" value="2.0" step="0.01" min="1.01" oninput="updateCalculations()">
            <div style="font-size: 0.8em; color:#999; margin-top:4px;">ä¾‹å¦‚: 2.0 ä»£è¡¨ 1èµ”1 (æœ¬é‡‘ç¿»å€)</div>
        </div>

        <div class="input-group">
            <label class="label">å‡¯åˆ©æ¯”ä¾‹ (é£é™©æ§åˆ¶): <span id="fractionDisplay">100%</span></label>
            <input type="range" id="kellyFraction" min="10" max="100" value="100" step="10" oninput="updateCalculations()">
            <div style="font-size: 0.8em; color:#999; margin-top:4px;">å…¨å‡¯åˆ©æ³¢åŠ¨å¤§ï¼Œé€šå¸¸å»ºè®®ä½¿ç”¨åŠå‡¯åˆ©(50%)</div>
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">

        <div class="recommendation">
            <div class="rec-title">å»ºè®®ä¸‹æ³¨é‡‘é¢ (Next Bet)</div>
            <div>
                <span class="rec-amount" id="betAmountDisplay">0</span>
                <span class="rec-percent" id="betPercentDisplay">(0%)</span>
            </div>
            <div id="kellyAdvice" style="font-size: 0.85rem; margin-top: 5px; color: var(--success);"></div>
        </div>

        <div class="btn-group">
            <button class="btn-primary" onclick="simulateRound(1)">æ¨¡æ‹Ÿ 1 è½®</button>
            <button class="btn-outline" onclick="simulateRound(10)">å¿«è¿› 10 è½®</button>
            <button class="btn-reset" onclick="resetGame()">é‡ç½®ç³»ç»Ÿ</button>
        </div>
    </div>

    <!-- å³ä¾§ï¼šå›¾è¡¨ä¸ç»“æœ -->
    <div class="card results-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>ğŸ“ˆ èµ„é‡‘æ›²çº¿</h2>
            <div style="text-align:right;">
                <span class="label">å½“å‰å‡€å€¼</span>
                <span class="stat-value" id="currentBalanceDisplay">10,000</span>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="balanceChart"></canvas>
        </div>

        <div class="stats-grid" style="margin-top: 20px;">
            <div class="stat-box">
                <span class="label">äº¤æ˜“æ¬¡æ•°</span>
                <div class="stat-value" style="color:var(--text-main)" id="tradeCount">0</div>
            </div>
            <div class="stat-box">
                <span class="label">èƒœç‡ (å®é™…)</span>
                <div class="stat-value" style="color:var(--text-main)" id="actualWinRate">0%</div>
            </div>
            <div class="stat-box">
                <span class="label">æ”¶ç›Šç‡</span>
                <div class="stat-value" id="roiDisplay">0%</div>
            </div>
            <div class="stat-box">
                <span class="label">æœ€å¤§å›æ’¤</span>
                <div class="stat-value red" id="maxDrawdownDisplay">0%</div>
            </div>
        </div>

        <h3>ğŸ“ æ¨¡æ‹Ÿæ—¥å¿—</h3>
        <div class="history-log" id="logContainer">
            <!-- æ—¥å¿—æ¡ç›® -->
        </div>
    </div>
</div>

<script>
    // çŠ¶æ€å˜é‡
    let balance = 10000;
    let history = [10000];
    let tradeCount = 0;
    let wins = 0;
    let maxBalance = 10000;
    let maxDrawdown = 0;
    
    // å›¾è¡¨ç›¸å…³
    const canvas = document.getElementById('balanceChart');
    const ctx = canvas.getContext('2d');
    let chartWidth, chartHeight;

    // åˆå§‹åŒ–
    window.onload = function() {
        resizeChart();
        resetGame();
        window.addEventListener('resize', resizeChart);
    };

    function resizeChart() {
        chartWidth = canvas.parentElement.offsetWidth;
        chartHeight = canvas.parentElement.offsetHeight;
        canvas.width = chartWidth;
        canvas.height = chartHeight;
        drawChart();
    }

    // æ ¸å¿ƒè®¡ç®—é€»è¾‘ï¼šå‡¯åˆ©å…¬å¼
    function calculateKelly() {
        const p = parseFloat(document.getElementById('winRate').value) / 100;
        const b = parseFloat(document.getElementById('odds').value) - 1;
        const fraction = parseInt(document.getElementById('kellyFraction').value) / 100;

        if (b <= 0) return 0; // èµ”ç‡å¿…é¡»å¤§äº1

        // å‡¯åˆ©å…¬å¼ f* = (bp - q) / b = p - q/b
        const q = 1 - p;
        let kellyPct = (b * p - q) / b;

        // åº”ç”¨å‡¯åˆ©æ¯”ä¾‹ï¼ˆå¦‚åŠå‡¯åˆ©ï¼‰
        kellyPct = kellyPct * fraction;

        return kellyPct;
    }

    function updateCalculations() {
        // æ›´æ–°æ»‘å—æ˜¾ç¤º
        document.getElementById('fractionDisplay').innerText = document.getElementById('kellyFraction').value + "%";

        const kellyPct = calculateKelly();
        const betAmountDisplay = document.getElementById('betAmountDisplay');
        const betPercentDisplay = document.getElementById('betPercentDisplay');
        const advice = document.getElementById('kellyAdvice');

        if (kellyPct <= 0) {
            betAmountDisplay.innerText = "0";
            betPercentDisplay.innerText = "(0%)";
            betAmountDisplay.style.color = "#94a3b8";
            advice.innerText = "æœŸæœ›å€¼ä¸ºè´Ÿï¼Œæ ¹æ®å‡¯åˆ©å…¬å¼ä¸åº”ä¸‹æ³¨ï¼";
            advice.style.color = "var(--danger)";
            return 0;
        } else {
            const betAmount = Math.floor(balance * kellyPct);
            betAmountDisplay.innerText = betAmount.toLocaleString();
            betPercentDisplay.innerText = `(${ (kellyPct * 100).toFixed(2) }%)`;
            betAmountDisplay.style.color = "var(--primary)";
            advice.innerText = "æ­£æœŸæœ›å€¼ï¼Œå»ºè®®ä»“ä½å¦‚ä¸Š";
            advice.style.color = "var(--success)";
            return betAmount; // è¿”å›å»ºè®®é‡‘é¢
        }
    }

    // æ¨¡æ‹Ÿäº¤æ˜“
    function simulateRound(rounds) {
        const p = parseFloat(document.getElementById('winRate').value) / 100;
        const odds = parseFloat(document.getElementById('odds').value);
        
        for(let i=0; i<rounds; i++) {
            if (balance <= 1) { // ç ´äº§ä¿æŠ¤
                logTrade("ç ´äº§", 0, 0, "èµ„é‡‘ä¸è¶³æ— æ³•ç»§ç»­");
                break;
            }

            const kellyPct = calculateKelly();
            if (kellyPct <= 0) {
                alert("æœŸæœ›å€¼ä¸ºè´Ÿï¼Œç³»ç»Ÿåœæ­¢è‡ªåŠ¨äº¤æ˜“ã€‚");
                break;
            }

            const betAmount = Math.floor(balance * kellyPct);
            if (betAmount < 1) break;

            // æ¨¡æ‹Ÿéšæœºç»“æœ
            const isWin = Math.random() < p;
            let change = 0;

            if (isWin) {
                change = betAmount * (odds - 1);
                balance += change;
                wins++;
            } else {
                change = -betAmount;
                balance += change;
            }

            tradeCount++;
            history.push(balance);
            
            // è®¡ç®—æœ€å¤§å›æ’¤
            if (balance > maxBalance) maxBalance = balance;
            const currentDD = (maxBalance - balance) / maxBalance;
            if (currentDD > maxDrawdown) maxDrawdown = currentDD;

            logTrade(isWin ? "ç›ˆåˆ©" : "äºæŸ", betAmount, change);
        }

        updateUI();
    }

    function updateUI() {
        updateCalculations();
        document.getElementById('currentBalanceDisplay').innerText = Math.floor(balance).toLocaleString();
        document.getElementById('tradeCount').innerText = tradeCount;
        
        const actualRate = tradeCount > 0 ? (wins / tradeCount * 100).toFixed(1) : 0;
        document.getElementById('actualWinRate').innerText = actualRate + "%";

        const initial = parseFloat(document.getElementById('initialCapital').value);
        const roi = ((balance - initial) / initial * 100).toFixed(2);
        const roiEl = document.getElementById('roiDisplay');
        roiEl.innerText = (roi > 0 ? "+" : "") + roi + "%";
        roiEl.className = "stat-value " + (roi >= 0 ? "green" : "red");

        document.getElementById('maxDrawdownDisplay').innerText = (maxDrawdown * 100).toFixed(2) + "%";

        drawChart();
    }

    function logTrade(type, bet, change, msg) {
        const log = document.getElementById('logContainer');
        const div = document.createElement('div');
        div.className = 'log-item';
        
        if(msg) {
            div.innerHTML = `<span class="loss">${msg}</span>`;
        } else {
            const colorClass = type === "ç›ˆåˆ©" ? "win" : "loss";
            const sign = type === "ç›ˆåˆ©" ? "+" : "";
            div.innerHTML = `
                <span>#${tradeCount} ä¸‹æ³¨: ${bet.toLocaleString()}</span>
                <span class="${colorClass}">${type}: ${sign}${Math.floor(change).toLocaleString()}</span>
            `;
        }
        
        log.insertBefore(div, log.firstChild);
    }

    function resetGame() {
        balance = parseFloat(document.getElementById('initialCapital').value);
        history = [balance];
        tradeCount = 0;
        wins = 0;
        maxBalance = balance;
        maxDrawdown = 0;
        document.getElementById('logContainer').innerHTML = '';
        updateUI();
    }

    // ç®€å•çš„ Canvas ç»˜å›¾å‡½æ•° (æ— éœ€å¤–éƒ¨åº“)
    function drawChart() {
        ctx.clearRect(0, 0, chartWidth, chartHeight);
        
        if (history.length < 1) return;

        // æ‰¾å‡ºæ•°æ®çš„æå€¼ä»¥ä¾¿ç¼©æ”¾
        let minVal = Math.min(...history);
        let maxVal = Math.max(...history);
        
        // ç•™ä¸€ç‚¹ä¸Šä¸‹è¾¹è·
        const padding = 40;
        const range = maxVal - minVal;
        // é˜²æ­¢é™¤ä»¥0
        const scaleY = (chartHeight - padding * 2) / (range === 0 ? 1 : range);
        const scaleX = (chartWidth - padding) / Math.max(1, history.length - 1);

        // ç»˜åˆ¶åŸºå‡†çº¿ (åˆå§‹æœ¬é‡‘)
        const initial = parseFloat(document.getElementById('initialCapital').value);
        const zeroY = chartHeight - padding - (initial - minVal) * scaleY;
        
        ctx.beginPath();
        ctx.strokeStyle = '#e2e8f0';
        ctx.setLineDash([5, 5]);
        ctx.moveTo(0, zeroY);
        ctx.lineTo(chartWidth, zeroY);
        ctx.stroke();
        ctx.setLineDash([]);

        // ç»˜åˆ¶æŠ˜çº¿
        ctx.beginPath();
        ctx.strokeStyle = '#2563eb';
        ctx.lineWidth = 2;
        
        history.forEach((val, index) => {
            const x = index * scaleX;
            const y = chartHeight - padding - (val - minVal) * scaleY;
            if (index === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        
        ctx.stroke();

        // ç»˜åˆ¶æ¸å˜å¡«å……
        ctx.lineTo(chartWidth, chartHeight);
        ctx.lineTo(0, chartHeight);
        ctx.fillStyle = 'rgba(37, 99, 235, 0.05)';
        ctx.fill();

        // æ ‡å‡ºç»ˆç‚¹åœ†ç‚¹
        const lastX = (history.length - 1) * scaleX;
        const lastY = chartHeight - padding - (history[history.length - 1] - minVal) * scaleY;
        ctx.beginPath();
        ctx.fillStyle = '#2563eb';
        ctx.arc(lastX, lastY, 4, 0, Math.PI * 2);
        ctx.fill();
    }

</script>

</body>
</html>